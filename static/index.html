<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Public Speaking Assessment</title>
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: #f5f5f7;
  min-height: 100vh;
  padding: 20px;
}

.container {
  max-width: 1200px;
  margin: 0 auto;
  background: white;
  border-radius: 12px;
  padding: 40px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.header {
  margin-bottom: 30px;
}

.back-btn {
  background: none;
  border: none;
  color: #666;
  font-size: 16px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 15px;
  padding: 8px;
}

.back-btn:hover {
  color: #333;
}

h1 {
  color: #1d1d1f;
  margin-bottom: 5px;
  font-size: 2.2em;
  font-weight: 600;
}

.analyzed-date {
  color: #86868b;
  font-size: 0.95em;
}

.upload-section {
  border: 2px dashed #d2d2d7;
  border-radius: 12px;
  padding: 60px 40px;
  text-align: center;
  margin-bottom: 30px;
  background: #fafafa;
  transition: all 0.3s;
  cursor: pointer;
}

.upload-section:hover {
  border-color: #0071e3;
  background: #f5f8ff;
}

.upload-section.drag-over {
  border-color: #0071e3;
  background: #e6f2ff;
  transform: scale(1.02);
}

input[type="file"] {
  display: none;
}

.upload-btn {
  background: #0071e3;
  color: white;
  padding: 12px 32px;
  border: none;
  border-radius: 8px;
  font-size: 1em;
  cursor: pointer;
  transition: all 0.2s;
  font-weight: 500;
}

.upload-btn:hover {
  background: #0077ed;
}

.filename {
  margin-top: 15px;
  color: #0071e3;
  font-weight: 500;
}

.file-size {
  margin-top: 8px;
  color: #86868b;
  font-size: 0.9em;
}

.processing {
  text-align: center;
  padding: 60px 30px;
  display: none;
}

.spinner {
  border: 3px solid #f3f3f3;
  border-top: 3px solid #0071e3;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  animation: spin 1s linear infinite;
  margin: 0 auto 20px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.progress-bar {
  width: 100%;
  max-width: 400px;
  height: 8px;
  background: #f0f0f0;
  border-radius: 4px;
  overflow: hidden;
  margin: 20px auto;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #0071e3, #00a8ff);
  border-radius: 4px;
  transition: width 0.3s ease;
  width: 0%;
}

.progress-text {
  color: #86868b;
  margin-top: 10px;
  font-size: 0.9em;
}

.results {
  display: none;
}

.metrics-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
  gap: 16px;
  margin-bottom: 30px;
}

.metric-card {
  background: white;
  border: 1px solid #e5e5e7;
  border-radius: 12px;
  padding: 20px;
  transition: all 0.2s;
}

.metric-card:hover {
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  transform: translateY(-2px);
}

.metric-icon {
  color: #86868b;
  font-size: 0.9em;
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.metric-value {
  font-size: 2em;
  font-weight: 700;
  color: #1d1d1f;
}

.tabs {
  display: flex;
  gap: 8px;
  margin-bottom: 30px;
  background: #f5f5f7;
  padding: 4px;
  border-radius: 10px;
}

.tab {
  flex: 1;
  padding: 12px 20px;
  border: none;
  background: transparent;
  border-radius: 8px;
  cursor: pointer;
  font-size: 0.95em;
  font-weight: 500;
  color: #1d1d1f;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.tab:hover {
  background: rgba(0, 0, 0, 0.05);
}

.tab.active {
  background: white;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.tab-content {
  display: none;
}

.tab-content.active {
  display: block;
  animation: fadeIn 0.3s;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.content-card {
  background: white;
  border: 1px solid #e5e5e7;
  border-radius: 12px;
  padding: 24px;
  margin-bottom: 20px;
}

.content-title {
  font-size: 1.4em;
  font-weight: 600;
  color: #1d1d1f;
  margin-bottom: 8px;
}

.content-description {
  color: #86868b;
  margin-bottom: 20px;
  line-height: 1.5;
}

.media-player {
  border-radius: 12px;
  overflow: hidden;
  margin: 20px 0;
}

audio {
  width: 100%;
  background: linear-gradient(135deg, #f8f9ff 0%, #e8e9ff 100%);
  border-radius: 12px;
  padding: 10px;
  border: 2px solid #0071e3;
  box-shadow: 0 4px 15px rgba(0, 113, 227, 0.15);
}

video {
  width: 100%;
  max-height: 500px;
  background: #000;
  border-radius: 12px;
}

.assessment-badge {
  display: inline-block;
  padding: 8px 16px;
  border-radius: 20px;
  font-size: 0.9em;
  font-weight: 600;
  margin-top: 12px;
}

.badge-excellent {
  background: #d1f4e0;
  color: #0f6938;
}

.badge-good {
  background: #fff3cd;
  color: #856404;
}

.checklist {
  margin-top: 20px;
}

.checklist h4 {
  font-size: 1.1em;
  margin-bottom: 12px;
  color: #1d1d1f;
}

.checklist ul {
  list-style: none;
  padding: 0;
}

.checklist li {
  padding: 10px 0;
  color: #1d1d1f;
  border-bottom: 1px solid #e5e5e7;
}

.checklist li:last-child {
  border-bottom: none;
}

.checklist li::before {
  content: "‚Ä¢ ";
  color: #0071e3;
  font-weight: bold;
  margin-right: 8px;
}

.word-cloud-container {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  margin: 24px 0;
  padding: 20px;
  background: #fafafa;
  border-radius: 12px;
  min-height: 120px;
  align-items: flex-start;
}

.cloud-word {
  background: white;
  border: 1px solid #e5e5e7;
  border-radius: 8px;
  padding: 10px 16px;
  font-size: 0.95em;
  color: #1d1d1f;
  font-weight: 500;
  transition: all 0.2s ease;
  cursor: default;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
  display: inline-flex;
  align-items: center;
  gap: 8px;
}

.cloud-word:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  border-color: #0071e3;
}

.cloud-word-text {
  font-weight: 600;
}

.cloud-word-count {
  color: #86868b;
  font-size: 0.9em;
}

.word-cloud-empty {
  color: #86868b;
  font-size: 1em;
  text-align: center;
  width: 100%;
  padding: 20px;
}

.transcript-box {
  background: #fafafa;
  padding: 24px;
  border-radius: 12px;
  line-height: 1.8;
  color: #1d1d1f;
  font-size: 1.05em;
}

.filler-word {
  background: #fff3cd;
  padding: 2px 4px;
  border-radius: 3px;
  font-weight: 600;
}

.footer-btn {
  background: #0071e3;
  color: white;
  padding: 14px 40px;
  border: none;
  border-radius: 8px;
  font-size: 1em;
  cursor: pointer;
  display: block;
  margin: 40px auto 0;
  font-weight: 500;
  transition: all 0.2s;
}

.footer-btn:hover {
  background: #0077ed;
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(0, 113, 227, 0.3);
}
</style>
</head>
<body>
<div class="container">
  <!-- Upload Section -->
  <div id="uploadView">
    <div class="header">
      <h1>Master Your Voice üì£</h1>
      <p class="analyzed-date">Upload a video to analyze your speaking skills</p>
    </div>
    
    <div class="upload-section" id="dropZone">
      <div style="font-size:3em; margin-bottom:20px;">üìπ</div>
      <p style="margin-bottom:20px; font-size:1.1em; color:#86868b;">Drag & drop your video or click to browse</p>
      <p style="margin-bottom:20px; font-size:0.95em; color:#0071e3; font-weight:600;">
        Supports MP4, WebM, MOV
      </p>
      <input type="file" id="videoInput" accept="video/*">
      <button class="upload-btn" onclick="document.getElementById('videoInput').click()">Choose Video</button>
      <div class="filename" id="filename"></div>
      <div class="file-size" id="filesize"></div>
    </div>
  </div>
  
  <!-- Processing -->
  <div class="processing" id="processing">
    <div class="spinner"></div>
    <p style="color:#1d1d1f; font-size:1.1em; margin-bottom:8px;">Processing your video...</p>
    <div class="progress-bar">
      <div class="progress-fill" id="progressFill"></div>
    </div>
    <p class="progress-text" id="progressText">Uploading...</p>
  </div>
  
  <!-- Results View -->
  <div class="results" id="results">
    <div class="header">
      <button class="back-btn" onclick="resetApp()">‚Üê Back</button>
      <h1>Your Assessment</h1>
      <p class="analyzed-date">Analyzed just now</p>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" onclick="switchTab(event, 'audio')">üîä Audio Analysis</button>
      <button class="tab" onclick="switchTab(event, 'video')">üé• Body Language</button>
      <button class="tab" onclick="switchTab(event, 'transcript')">üìÑ Transcript</button>
    </div>

    <!-- Audio Tab -->
    <div class="tab-content active" id="audioTab">
      <div class="content-card">
        <h2 class="content-title">Audio Analysis</h2>
        <p class="content-description">Listen to your speech and review your vocal delivery.</p>
        <div class="media-player">
          <audio id="audioOnly" controls></audio>
        </div>
        <div class="metrics-grid" style="margin-top:24px;">
          <div class="metric-card">
            <div class="metric-icon">üìä Speech Rate</div>
            <div class="metric-value" id="speechRate">-- wpm</div>
          </div>
          <div class="metric-card">
            <div class="metric-icon">‚è±Ô∏è Duration</div>
            <div class="metric-value" id="duration">--</div>
          </div>
        </div>
        <div style="margin-top:24px;">
          <strong style="color:#1d1d1f;">Assessment:</strong>
          <span class="assessment-badge" id="ratebadge"></span>
          <p style="color:#86868b; margin-top:8px;" id="rateAssessment"></p>
        </div>
      </div>
    </div>

    <!-- Video Tab -->
    <div class="tab-content" id="videoTab">
      <div class="content-card">
        <h2 class="content-title">Body Language Review</h2>
        <p class="content-description">Watch your video without sound to focus on gestures and body language.</p>
        <div class="media-player">
          <video id="videoOnly" controls muted></video>
        </div>
        <div class="checklist">
          <h4>Things to observe:</h4>
          <ul>
            <li>Are you making eye contact with the camera?</li>
            <li>Is your posture confident and open?</li>
            <li>Are your gestures natural and purposeful?</li>
            <li>Do you appear engaged and energetic?</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Transcript Tab -->
    <div class="tab-content" id="transcriptTab">
      <div class="content-card">
        <h2 class="content-title">Transcript & Filler Words</h2>
        <p class="content-description">Review your speech text with filler words highlighted in yellow.</p>
        <div class="metrics-grid" style="margin-bottom:24px;">
          <div class="metric-card">
            <div class="metric-icon">üé§ Total Filler Words</div>
            <div class="metric-value" id="fillerWords">--</div>
          </div>
          <div class="metric-card">
            <div class="metric-icon">‚ö° Filler Rate</div>
            <div class="metric-value" id="fillerRate">-- /min</div>
          </div>
        </div>
        <h3 style="font-size:1.2em; margin-bottom:12px; color:#1d1d1f;">Most Common Filler Words</h3>
        <div class="word-cloud-container" id="wordCloud">
          <div class="word-cloud-empty">No filler words detected! üéâ</div>
        </div>
        <h3 style="font-size:1.2em; margin-top:32px; margin-bottom:12px; color:#1d1d1f;">Full Transcript</h3>
        <div class="transcript-box" id="transcript">Transcription will appear here...</div>
      </div>
    </div>

    <button class="footer-btn" onclick="resetApp()">Analyze Another Video</button>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/ffmpeg/0.11.6/ffmpeg.min.js"></script>
<script>
const API_URL = '';

// DOM Elements
const videoElement = document.getElementById('videoOnly');
const audioElement = document.getElementById('audioOnly');
const videoInput = document.getElementById('videoInput');
const uploadView = document.getElementById('uploadView');
const processing = document.getElementById('processing');
const results = document.getElementById('results');
const progressFill = document.getElementById('progressFill');
const progressText = document.getElementById('progressText');
const filename = document.getElementById('filename');
const filesize = document.getElementById('filesize');
const dropZone = document.getElementById('dropZone');

// Event Listeners
videoInput.addEventListener('change', handleFileSelect);
dropZone.addEventListener('dragover', handleDragOver);
dropZone.addEventListener('dragleave', handleDragLeave);
dropZone.addEventListener('drop', handleDrop);

// Prevent unmuting the video element in Body Language tab
videoElement.addEventListener('volumechange', (e) => {
  videoElement.muted = true;
});

// Continuously monitor and enforce muted state
setInterval(() => {
  videoElement.muted = true;
  videoElement.volume = 0;
}, 100);

function handleFileSelect(e) {
  if (!e.target.files.length) return;
  loadVideo(e.target.files[0]);
}

function handleDragOver(e) {
  e.preventDefault();
  e.stopPropagation();
  dropZone.classList.add('drag-over');
}

function handleDragLeave(e) {
  e.preventDefault();
  e.stopPropagation();
  dropZone.classList.remove('drag-over');
}

function handleDrop(e) {
  e.preventDefault();
  e.stopPropagation();
  dropZone.classList.remove('drag-over');
  
  const files = e.dataTransfer.files;
  if (files.length) {
    loadVideo(files[0]);
  }
}

function formatFileSize(bytes) {
  if (bytes === 0) return '0 Bytes';
  const k = 1024;
  const sizes = ['Bytes', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

async function loadVideo(file) {
  const originalSize = file.size;
  filename.textContent = file.name;
  filesize.textContent = `Original size: ${formatFileSize(originalSize)}`;
  
  // Show processing immediately
  uploadView.style.display = 'none';
  processing.style.display = 'block';
  progressFill.style.width = '10%';
  progressText.textContent = 'Compressing video...';
  
  try {
    // Compress video if it's larger than 50MB
    let processedFile = file;
    if (originalSize > 50 * 1024 * 1024) {
      processedFile = await compressVideo(file);
      const compressedSize = processedFile.size;
      const savings = ((1 - compressedSize / originalSize) * 100).toFixed(0);
      filesize.textContent = `Compressed: ${formatFileSize(compressedSize)} (${savings}% smaller)`;
    }
    
    // Set up local playback with the original file
    const objectURL = URL.createObjectURL(file);
    videoElement.src = objectURL;
    videoElement.muted = true;
    audioElement.src = objectURL;
    
    // Process the compressed file
    processVideo(processedFile);
  } catch (error) {
    alert(`Compression failed: ${error.message}. Uploading original file...`);
    const objectURL = URL.createObjectURL(file);
    videoElement.src = objectURL;
    videoElement.muted = true;
    audioElement.src = objectURL;
    processVideo(file);
  }
}

async function compressVideo(file) {
  progressText.textContent = 'Compressing video (this may take a minute)...';
  
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = async function(e) {
      const videoBlob = new Blob([e.target.result], { type: file.type });
      
      // Create video element to get dimensions
      const video = document.createElement('video');
      video.src = URL.createObjectURL(videoBlob);
      
      await new Promise(res => {
        video.onloadedmetadata = res;
      });
      
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      
      // Reduce resolution to 720p max
      const scale = Math.min(1, 1280 / video.videoWidth, 720 / video.videoHeight);
      canvas.width = video.videoWidth * scale;
      canvas.height = video.videoHeight * scale;
      
      // Use MediaRecorder to re-encode
      const stream = canvas.captureStream(24); // 24fps
      
      // Add audio track from original video
      const audioContext = new AudioContext();
      const source = audioContext.createMediaElementSource(video);
      const dest = audioContext.createMediaStreamDestination();
      source.connect(dest);
      source.connect(audioContext.destination);
      
      stream.addTrack(dest.stream.getAudioTracks()[0]);
      
      const mediaRecorder = new MediaRecorder(stream, {
        mimeType: 'video/webm;codecs=vp8,opus',
        videoBitsPerSecond: 1000000 // 1 Mbps
      });
      
      const chunks = [];
      mediaRecorder.ondataavailable = (e) => chunks.push(e.data);
      mediaRecorder.onstop = () => {
        const compressedBlob = new Blob(chunks, { type: 'video/webm' });
        const compressedFile = new File([compressedBlob], file.name.replace(/\.[^.]+$/, '.webm'), {
          type: 'video/webm'
        });
        resolve(compressedFile);
      };
      
      mediaRecorder.start();
      video.play();
      
      // Draw frames
      const drawFrame = () => {
        if (video.ended || video.paused) {
          mediaRecorder.stop();
          return;
        }
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        requestAnimationFrame(drawFrame);
      };
      
      drawFrame();
      
      // Stop after video ends
      video.onended = () => {
        setTimeout(() => mediaRecorder.stop(), 100);
      };
    };
    
    reader.onerror = reject;
    reader.readAsArrayBuffer(file);
  });
}

async function processVideo(file) {
  progressFill.style.width = '30%';
  progressText.textContent = 'Uploading to server...';

  const formData = new FormData();
  formData.append('video', file);

  try {
    progressFill.style.width = '50%';
    progressText.textContent = 'Transcribing speech...';
    
    const response = await fetch(`${API_URL}/analyze`, {
      method: 'POST',
      body: formData
    });
    
    const data = await response.json();
    
    if (!response.ok) {
      throw new Error(data.error || 'Server error');
    }
    
    progressFill.style.width = '100%';
    progressText.textContent = 'Complete!';
    
    setTimeout(() => displayResults(data), 500);
  } catch (err) {
    alert(`Error: ${err.message}`);
    resetApp();
  }
}

function displayResults(data) {
  processing.style.display = 'none';
  results.style.display = 'block';
  
  // Populate metrics
  document.getElementById('speechRate').textContent = `${data.words_per_min} wpm`;
  document.getElementById('duration').textContent = `${Math.floor(data.duration / 60)}:${String(Math.floor(data.duration % 60)).padStart(2, '0')}`;
  document.getElementById('fillerWords').textContent = data.filler_count;
  document.getElementById('fillerRate').textContent = `${data.filler_rate_per_min} /min`;
  
  // Display transcript with highlighted filler words
  document.getElementById('transcript').innerHTML = highlightFillerWords(data.transcript);
  
  // Display word cloud
  if (data.filler_words && Object.keys(data.filler_words).length > 0) {
    displayWordCloud(data.filler_words);
  }
  
  // Set assessment badge
  const badgeEl = document.getElementById('ratebadge');
  const assessment = data.assessment?.pace || '';
  
  if (assessment.includes('Excellent')) {
    badgeEl.textContent = 'Excellent';
    badgeEl.className = 'assessment-badge badge-excellent';
  } else if (assessment.includes('Good')) {
    badgeEl.textContent = 'Good';
    badgeEl.className = 'assessment-badge badge-good';
  } else {
    badgeEl.textContent = 'Needs Improvement';
    badgeEl.className = 'assessment-badge';
  }
  
  document.getElementById('rateAssessment').textContent = assessment;
}

function highlightFillerWords(text) {
  const fillerWords = [
    'um', 'uh', 'like', 'you know', 'so', 
    'actually', 'basically', 'literally', 'right', 'okay', 'well', 'i mean'
  ];
  
  let highlighted = text;
  
  fillerWords.forEach(word => {
    const regex = new RegExp(`\\b${word}\\b`, 'gi');
    highlighted = highlighted.replace(regex, match => `<span class="filler-word">${match}</span>`);
  });
  
  return highlighted;
}

function displayWordCloud(fillerWords) {
  const cloudContainer = document.getElementById('wordCloud');
  cloudContainer.innerHTML = '';
  
  const sortedWords = Object.entries(fillerWords)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 10);
  
  sortedWords.forEach(([word, count]) => {
    const wordEl = document.createElement('div');
    wordEl.className = 'cloud-word';
    wordEl.innerHTML = `
      <span class="cloud-word-text">${word}</span>
      <span class="cloud-word-count">x${count}</span>
    `;
    cloudContainer.appendChild(wordEl);
  });
}

function switchTab(e, tabName) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  e.target.classList.add('active');
  
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  document.getElementById(tabName + 'Tab').classList.add('active');
}

function resetApp() {
  uploadView.style.display = 'block';
  processing.style.display = 'none';
  results.style.display = 'none';
  
  videoInput.value = '';
  filename.textContent = '';
  filesize.textContent = '';
  videoElement.src = '';
  audioElement.src = '';
  
  // Reset to first tab
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelector('.tab').classList.add('active');
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  document.getElementById('audioTab').classList.add('active');
}
</script>
</body>
</html>